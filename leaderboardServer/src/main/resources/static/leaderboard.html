<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/style.css">
    <title>Leaderboard</title>
</head>
<body>
<header>
<a href="index.html" id="center">
    <button class="back-button" type="button" id="back"> Back</button>
</a>
</header>

<div id="leaderboard-container">
    <table id="leaderboard">
        <thead>
            <tr>
                <th>
                    <form id="frm" >
                        <label for="leaderboardId"></label>
                        <input placeholder="Rank" value="" id="rank" name="rank">
                    </form>
                </th>
                <th>
                    <form id="frm2" >
                        <label for="rank"></label>
                        <input placeholder="Name" value="" id="leaderboardId" name="leaderboardId">
                    </form>
                </th>
                <th>
                    <div id="btn-switch-wrapper">
                        <form id="frm3" >
                            <label for="score"></label>
                            <input placeholder="Score" value="" id="score" name="score">
                        </form>
                        <form id="btn-switch-form">
                            <button id="btn-switch" onclick="switchOrder()">
                                <svg xmlns="http://www.w3.org/2000/svg" height="1.2em" viewBox="0 0 576 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M151.6 42.4C145.5 35.8 137 32 128 32s-17.5 3.8-23.6 10.4l-88 96c-11.9 13-11.1 33.3 2 45.2s33.3 11.1 45.2-2L96 146.3V448c0 17.7 14.3 32 32 32s32-14.3 32-32V146.3l32.4 35.4c11.9 13 32.2 13.9 45.2 2s13.9-32.2 2-45.2l-88-96zM320 480h32c17.7 0 32-14.3 32-32s-14.3-32-32-32H320c-17.7 0-32 14.3-32 32s14.3 32 32 32zm0-128h96c17.7 0 32-14.3 32-32s-14.3-32-32-32H320c-17.7 0-32 14.3-32 32s14.3 32 32 32zm0-128H480c17.7 0 32-14.3 32-32s-14.3-32-32-32H320c-17.7 0-32 14.3-32 32s14.3 32 32 32zm0-128H544c17.7 0 32-14.3 32-32s-14.3-32-32-32H320c-17.7 0-32 14.3-32 32s14.3 32 32 32z"/></svg>
                            </button>
                        </form>
                    </div>
                </th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    const url = "http://localhost:7070/";
    let players = [];
    let numberOfPlayers;
    let lowestIndex;
    let highestIndex;
    let playersPerFetch = 50;
    const form = document.getElementById("frm");
    const form2 = document.getElementById("frm2");
    let leaderboardId = 1;
    let table = document.getElementById("leaderboard");
    let isEventProcessing = false;

    form2.addEventListener("submit",  handleSubmit);
    form.addEventListener("submit",  handleSubmitRank);

    function scrollToRow(rowNumber) {
        let row = table.rows[rowNumber];
        if (row) {
            row.scrollIntoView({ block: 'start', inline: "nearest"});
        }
    }

    document.getElementById('btn-switch').addEventListener('click', function() {
        let svg = document.querySelector('svg');
        svg.classList.toggle('rotate180');
    });


    function handleSubmit(e){
        e.preventDefault();

        let input = parseInt(document.getElementById("leaderboardId").value);
        if (isNaN(input)) {
            return;
        }
        if (input < 1) {
            alert("LeaderboardID below 1 does not exist");
            return;
        }
        isEventProcessing = true;

        leaderboardId = input;
        tableClear();
        tableInsert(0, playersPerFetch - 1);
        isEventProcessing = false;
    }

    async function handleSubmitRank(e) {
        e.preventDefault();
        let input = parseInt(document.getElementById("rank").value);
        if (isNaN(input)) {
            return;
        }

        await getNumberOfPlayers()
        if (input > numberOfPlayers) {
            alert(`Search Failed: Lowest Rank: ${numberOfPlayers}`);
            return;
        }
        if (input < 1) {
            alert("Rank below 1 does not exist");
            return;
        }
        tableClear();
        await tableInsert(input - 1 - playersPerFetch, input + playersPerFetch - 1);
        if (input > playersPerFetch) {
            scrollToRow(playersPerFetch-1);
        } else {
            scrollToRow(input-2);
        }

    }

    async function getNumberOfPlayers() {
        const response2 = await fetch(`${url}size?leaderboardId=${leaderboardId}`);
        numberOfPlayers = parseInt(await response2.json());
    }

    async function getPlayers(min, max) {
        players = [];
        //localhost:8080/players?min=15&max=5
        const response = await fetch(`${url}players?leaderboardId=${leaderboardId}&start=${min}&stop=${max}`);
        const data = await response.json();

        for(const i in data) {
            players.push(data[i]);
        }

    }

    function tableClear(){
        players = [];
        let tableHeader = table.rows[0].innerHTML;
        table.innerHTML = "";
        table.insertRow(0).innerHTML = tableHeader;
        lowestIndex = undefined;
        highestIndex = undefined;
    }

    //inserts data from API fetch into table rows
    async function tableInsert(startRange, endRange) {
        players = [];
        if (startRange < 0) {
            startRange = 0;
            if (endRange < 0) {
                return;
            }
        }
        //checks if first call
        if (lowestIndex === undefined) {
            lowestIndex = startRange;
        }
        if (highestIndex === undefined) {
            highestIndex = endRange+1;
        }
        //get number of users, should be improved so its called less
        await getNumberOfPlayers()

        await getPlayers(startRange, endRange);
        if (players.length === 0) {
            return;
        }
        let counter = startRange;
        let rows = table.rows.length
        if (startRange < lowestIndex) {
            rows = 1;
        }
        for (let i = 0; i < players.length; i++) {
            counter++;
            table.insertRow(i+rows).innerHTML = '<tr><td>' + (counter).toLocaleString() + '</td><td>' + players[i].element + '</td><td>' + players[i].score.toLocaleString() + '</td></tr>';
        }
        console.log(`Inserted ${startRange+1} to ${counter}`);
        if (startRange < lowestIndex) {
            lowestIndex = startRange;
        }
        if (endRange > highestIndex) {
            highestIndex = counter;
        }


    }

    //lowestIndex = 299; highestIndex = 299+usersPerFetch;
    tableInsert(0, playersPerFetch - 1);

    const div = document.querySelector("#leaderboard-container")

    div.addEventListener("scroll", async () => {
        if (isEventProcessing) {
            return; // If the event is already being processed, exit early
        }

        isEventProcessing = true;

        try {
            if (Math.abs(div.scrollHeight - div.clientHeight - div.scrollTop) < 1) {
                await tableInsert(highestIndex, highestIndex + playersPerFetch - 1);
            }
            if (div.scrollTop < 1 && lowestIndex > playersPerFetch / 2) {
                await tableInsert(lowestIndex - playersPerFetch, lowestIndex - 1);
                scrollToRow(playersPerFetch);
            }
        } finally {
            isEventProcessing = false;
        }
    }, {
        passive: true
    });



</script>

</body>
</html>