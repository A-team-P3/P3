<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/style.css">
    <title>Leaderboard</title>
</head>
<body>
<div class="Center">
    <header>Leaderboard</header>
    <div class="pageControls">
        <button onclick="
            list((pageNumber*usersPerPage)-usersPerPage, (pageNumber*usersPerPage)-1, true)
        ">Last Page</button>
        <p id="pageNumber"></p>
        <button onclick="
            list((pageNumber*usersPerPage)+usersPerPage, (pageNumber*usersPerPage)+usersPerPage*2-1, true)
        ">Next Page</button>
        <p id="indexNumber"></p>
    </div>
    <div id="slideContainer"></div>
    <div class="pageControls2"></div>
</div>

    <script>
        "use strict";
        const url = 'http://localhost:8080/users';
        let pageNumber = 0;
        const usersPerPage = 50;
        let numberOfUses;
        let ascending = true;

        function switchOrder() {
            ascending = !ascending;

            const cell = document.getElementById("leaderboard").rows[0].cells;

            ascending ? cell[2].innerHTML = "Score ↑" : cell[2].innerHTML = "Score ↓";

            list(pageNumber*usersPerPage, (pageNumber*usersPerPage)+usersPerPage-1, false)
        }

        async function getUsers(min, max) {
            let users = [];
            try {
                const [usersRes, numberOfUsersRes] = await Promise.all([
                    fetch(url + '?min=' + min +'&max=' + max),
                    fetch('http://localhost:8080/size')
                ]);

                // parse
                const userList = await usersRes.json();
                numberOfUses = await numberOfUsersRes.json();

                // add all user data to user list
                for(let i in userList) {
                    users.push(userList[i]);
                }

                // return user list
                return users;

            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        async function list(min, max, incrementPage) {

            if (min < 0) return; // sker det her??

            if (!ascending) {
                let temp = max;
                max = min;
                min = temp;
            }
            const users = await getUsers(min, max);

            // if db is empty
            if (users.length === 0) return;

            incrementPage && min/usersPerPage > pageNumber ? pageNumber++ : pageNumber--;

            document.getElementById("pageNumber").innerHTML = "Page: " + (pageNumber+1) + " of " + (Math.ceil(numberOfUses/usersPerPage))
            let counter;
            if (ascending) {
                counter = min;
                document.getElementById("indexNumber").innerHTML = "User: " + (counter+1) + " - " + ((counter)-(min-max)+1) + " of " + (numberOfUses).toLocaleString();
            } else {
                counter = numberOfUses-max+1;
                document.getElementById("indexNumber").innerHTML = "User: " + ((counter)-(min-max)-1) + " - " + (counter-1) + " of " + (numberOfUses).toLocaleString();
            }
            let score;
            if (document.getElementById("leaderboard") != null) {
                score = document.getElementById("leaderboard").rows[0].cells[2].innerHTML;
            }
            else {
                score = "Score ↑";
            }
            let str = '<table id="leaderboard">';

            str += '<thead><tr><th>Rank</th><th>Name</th><th onclick="switchOrder()">' + score + '</th></tr></thead>'
            users.forEach((user) => {

                ascending ? counter++ : counter-- ;

                str += '<tr><td>' + counter.toLocaleString() +'</td><td>'+ user.element + '</td><td>' + user.score.toLocaleString() + '</td></tr>';
            });

            str += '</table>';

            document.getElementById("slideContainer").innerHTML = str;
            console.log("hallo2");
            console.log(document.getElementById("leaderboard").rows.length); //wtf???? why does this not work?
        }

        list(pageNumber, pageNumber+usersPerPage-1, true);
        $(".pageControls").clone().appendTo(".pageControls2");



    </script>

</body>
</html>