<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/style.css">
    <title>Leaderboard</title>
</head>
<body>
<div class="Center">
    <header>Leaderboard</header>
    <div class="pageControls">
        <form id="frm" >
            <label for="leaderboardId">Leaderboard Id:</label>
            <input value="" id="leaderboardId" name="leaderboardId">

        </form>
    </div>
    <div id="slideContainer">
        <table id="leaderboard"> </table>
    </div>
</div>
<script>

    const url = 'http://localhost:8080/'
    let users = [];
    let numberOfUsers;
    let lowestIndex;
    let highestIndex;
    let usersPerFetch = 50;
    const form = document.getElementById("frm");
    let leaderboardId = 1;
    let table = document.getElementById("leaderboard");

    form.addEventListener("submit",  handleSubmit);

    function handleSubmit(e){
        e.preventDefault();

        let input = document.getElementById("leaderboardId");

        leaderboardId = input.value;
        tableClear();
        tableInsert(0, usersPerFetch-1);
    }



    async function getNumberOfUsers() {
        const response2 = await fetch(url + 'size');
        numberOfUsers = await response2.json();
    }

    async function getUsers(min, max) {
        users = [];
        //localhost:8080/users?min=15&max=5
        const response = await fetch(`${url}users?leaderboardId=${leaderboardId}&min=${min}&max=${max}`);
        const data = await response.json();



        for(const i in data) {
            users.push(data[i]);
        }

    }

    function tableClear(){
        let tableHeader = table.rows[0].innerHTML;
        table.innerHTML = "";
        table.insertRow(0).innerHTML = tableHeader;
    }

    //inserts data from API fetch into table rows
    async function tableInsert(startRange, endRange) {
        //console.log(`fi: ${startRange}, li: ${endRange}`)
        if (startRange < 0) {
            startRange = 0;
            if (endRange < 0) {
                //console.log("Both indexes less then 0");
                return;
            }
        }
        //checks if first call
        if (lowestIndex === undefined) {
            lowestIndex = startRange;
        }
        if (highestIndex === undefined) {
            highestIndex = endRange+1;
        }
        //get number of users, should be improved so its called less
        await getNumberOfUsers()
        //check if last index reached
        if (endRange > highestIndex && highestIndex == numberOfUsers) {
            return;
        }
        //check if end of requested range is above the number of users in the database
        if (endRange > numberOfUsers) {
            //set the range to the last index in the database
            // (if database has 400 users, and 390 to 440 is called, it sets index to 399
            endRange = numberOfUsers-1;
        }
        await getUsers(startRange, endRange);
        if (users.length === 0) {
            return;
        }
        let counter = startRange;
        let rows = table.rows.length
        if (startRange < lowestIndex) {
            //console.log("XDDDDDDDDDDD");
            rows = 1;
        }
        for (let i = 0; i < users.length; i++) {
            //console.log("index: " + i);
            counter++;
            table.insertRow(i+rows).innerHTML = '<tr><td>' + (counter).toLocaleString() + '</td><td>' + users[i].element + '</td><td>' + users[i].score.toLocaleString() + '</td></tr>';
        }
        //console.log(`li: ${lowestIndex}, hi: ${highestIndex}`)
        if (startRange < lowestIndex) {
            lowestIndex = startRange;
        }
        if (endRange > highestIndex) {
            highestIndex = counter;
        }


    }

    table.insertRow(0).innerHTML = '<thead><tr><th>Rank</th><th>Name</th><th onclick="switchOrder()">' + "score" + '</th></tr></thead><tbody></tbody>'

    //lowestIndex = 299; highestIndex = 299+usersPerFetch;
    tableInsert(0, usersPerFetch-1);


    const div = document.querySelector("#slideContainer")

    div.addEventListener("scroll", () => {
            //console.log(div.scrollHeight + ", " + div.clientHeight + ", " + div.scrollTop);
            if (Math.abs(div.scrollHeight - div.clientHeight - div.scrollTop) < 1) {
                //console.log("highest index: " + highestIndex);
                tableInsert(highestIndex, highestIndex+usersPerFetch-1);
            }
            if (div.scrollTop < 1 && lowestIndex > usersPerFetch/2) {
                //console.log(div.scrollHeight + ", " + div.clientHeight + ", " + div.scrollTop);
                div.scrollTop = 75;
                //console.log(table.rows[10].scrollTop);
                tableInsert(lowestIndex-usersPerFetch, lowestIndex-1);
            }
        },
        {
            passive: true
        }
    );



</script>

</body>
</html>